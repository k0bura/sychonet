---
interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {description && <meta name="description" content={description} />}
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title}</title>
  </head>
  <body>
    <div class="phone-wall">
      <pre>{`
▒▒▒ ACCESS DENIED ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒

> TERMINAL SIZE ERROR
> INSUFFICIENT COLUMN WIDTH
>
> Are you seriously trying to view
> this site on a phone? In ${new Date().getFullYear()}?
>
> This site was built for 80 columns.
> Your device has the screen real
> estate of a postage stamp.
>
> Go find a real computer.
> Preferably one that weighs at
> least 10lbs and has a CRT.
>
> NO CARRIER
`}</pre>
    </div>
    <main>
      <slot />
    </main>
    <footer>
      <p>&copy; {new Date().getFullYear()} k0bura | <a href={`${import.meta.env.BASE_URL}`}>~/sych0net</a></p>
    </footer>
    <div class="lightbox" id="lightbox">
      <button class="lb-prev" id="lb-prev">&#9664;</button>
      <img id="lightbox-img" src="" alt="" />
      <button class="lb-next" id="lb-next">&#9654;</button>
      <button class="lb-expand" id="lb-expand" title="Expand full resolution">&#x26F6;</button>
      <div class="lb-thumbs" id="lb-thumbs"></div>
      <span class="lightbox-hint" id="lb-hint">click or ESC to close</span>
    </div>
  </body>
</html>

<script>
  const lightbox = document.getElementById('lightbox')!;
  const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;
  const lbPrev = document.getElementById('lb-prev')!;
  const lbNext = document.getElementById('lb-next')!;
  const lbThumbs = document.getElementById('lb-thumbs')!;
  const lbHint = document.getElementById('lb-hint')!;
  const lbExpand = document.getElementById('lb-expand')!;

  const images = Array.from(document.querySelectorAll('article img')) as HTMLImageElement[];
  let currentIndex = 0;

  function collapseExpanded() {
    lightbox.classList.remove('expanded');
    lbExpand.innerHTML = '&#x26F6;';
    lbExpand.title = 'Expand full resolution';
  }

  function getFullSrc(img: HTMLImageElement): string {
    return img.dataset.full || img.src;
  }

  function showImage(index: number) {
    collapseExpanded();
    currentIndex = index;
    const img = images[currentIndex];
    lightboxImg.src = getFullSrc(img);
    lightboxImg.alt = img.alt;
    lbHint.textContent = `[${currentIndex + 1}/${images.length}] click or ESC to close`;

    lbThumbs.querySelectorAll('img').forEach((thumb, i) => {
      thumb.classList.toggle('active', i === currentIndex);
    });

    // scroll active thumb into view
    const activeThumb = lbThumbs.querySelector('img.active') as HTMLElement | null;
    if (activeThumb) {
      activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }
  }

  function buildThumbs() {
    lbThumbs.innerHTML = '';
    images.forEach((img, i) => {
      const thumb = document.createElement('img');
      thumb.src = img.src;
      thumb.alt = img.alt;
      thumb.addEventListener('click', (e) => {
        e.stopPropagation();
        showImage(i);
      });
      lbThumbs.appendChild(thumb);
    });
  }

  const isSingle = images.length <= 1;

  function openLightbox(index: number) {
    if (isSingle) {
      const img = images[0];
      lightboxImg.src = getFullSrc(img);
      lightboxImg.alt = img.alt;
      lbHint.textContent = 'click or ESC to close';
      lbThumbs.innerHTML = '';
      lbPrev.hidden = true;
      lbNext.hidden = true;
    } else {
      lbPrev.hidden = false;
      lbNext.hidden = false;
      buildThumbs();
      showImage(index);
    }
    lightbox.classList.add('active');
  }

  function closeLightbox() {
    collapseExpanded();
    lightbox.classList.remove('active');
  }

  images.forEach((img, i) => {
    img.addEventListener('click', () => openLightbox(i));
  });

  lightbox.addEventListener('click', (e) => {
    if (e.target === lightbox) closeLightbox();
  });

  lightboxImg.addEventListener('click', (e) => {
    e.stopPropagation();
    lbExpand.click();
  });

  lbPrev.addEventListener('click', (e) => {
    e.stopPropagation();
    showImage((currentIndex - 1 + images.length) % images.length);
  });

  lbNext.addEventListener('click', (e) => {
    e.stopPropagation();
    showImage((currentIndex + 1) % images.length);
  });

  lbExpand.addEventListener('click', (e) => {
    e.stopPropagation();
    if (lightbox.classList.contains('expanded')) {
      collapseExpanded();
    } else {
      lightbox.classList.add('expanded');
      lbExpand.innerHTML = '&#x2716;';
      lbExpand.title = 'Collapse to fitted view';
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey || e.altKey || e.metaKey) return;
    const tag = (e.target as HTMLElement).tagName;
    if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

    const isOpen = lightbox.classList.contains('active');

    if (e.key === 'Escape') {
      if (isOpen) {
        e.preventDefault();
        if (lightbox.classList.contains('expanded')) {
          collapseExpanded();
        } else {
          closeLightbox();
        }
        return;
      }
      e.preventDefault();
      window.location.href = '/';
      return;
    }

    if (isOpen) {
      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        e.stopPropagation();
        showImage((currentIndex - 1 + images.length) % images.length);
        return;
      }
      if (e.key === 'ArrowRight') {
        e.preventDefault();
        e.stopPropagation();
        showImage((currentIndex + 1) % images.length);
        return;
      }
      // block other keys from triggering page shortcuts while lightbox is open
      return;
    }

    const key = e.key.toUpperCase();

    if (window.location.pathname === '/' || window.location.pathname === '/index.html') {
      const routes: Record<string, string> = {
        P: '/projects/',
        H: '/hardware/',
        B: '/bulletin/',
        W: '/wall/',
        A: '/about/',
        L: '/links/',
        N: '/news/',
        F: '/files/',
        C: '/contact/',
        G: '/gallery/',
      };
      if (routes[key]) {
        e.preventDefault();
        window.location.href = routes[key];
      }
    }
  });
</script>

<style is:global>
  @font-face {
    font-family: 'IBM Plex Mono';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url('/fonts/ibm-plex-mono-regular.woff2') format('woff2');
  }

  @font-face {
    font-family: 'IBM Plex Mono';
    font-style: normal;
    font-weight: 700;
    font-display: swap;
    src: url('/fonts/ibm-plex-mono-bold.woff2') format('woff2');
  }

  body {
    font-family: 'IBM Plex Mono', monospace;
    background: #111;
    color: #c0c0c0;
    max-width: 80ch;
    margin: 0 auto;
    padding: 2rem 1rem;
    line-height: 1.6;
    font-size: min(1rem, 2vw);
  }

  a {
    color: #7799cc;
  }

  a:visited {
    color: #5577aa;
  }

  a:hover {
    color: #111;
    background: #7799cc;
  }

  h1, h2, h3, h4 {
    color: #ffcc00;
    font-weight: normal;
  }

  code {
    background: #1a1a1a;
    padding: 0.2em 0.4em;
    font-size: 0.95em;
  }

  pre {
    font-family: 'IBM Plex Mono', monospace;
    background: #1a1a1a !important;
    padding: 1rem;
    overflow-x: hidden;
    border: 1px solid #332b00;
  }

  pre code {
    background: none;
    padding: 0;
  }

  hr {
    border: none;
    border-top: 1px dashed #332b00;
    margin: 1.5rem 0;
  }

  header a {
    text-decoration: none;
    font-size: 1.2em;
  }

  footer {
    color: #665200;
    font-size: 0.9em;
  }

  ul {
    list-style: none;
    padding: 0;
  }

  article ul {
    padding-left: 2rem;
  }

  article ul li {
    position: relative;
  }

  article ul li::before {
    content: '>';
    color: #665200;
    position: absolute;
    left: -1.5rem;
  }

  article ol {
    padding-left: 1.5rem;
    color: #665200;
  }

  article ol li {
    padding-left: 0.3rem;
  }

  article ol li > * {
    color: #c0c0c0;
  }

  article li {
    margin: 0.3rem 0;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    margin: 1rem 0;
    font-size: 0.85em;
  }

  th {
    color: #ffcc00;
    text-align: left;
    border-bottom: 1px solid #665200;
    padding: 0.4rem 0.6rem;
  }

  td {
    border-bottom: 1px solid #1a1a1a;
    padding: 0.3rem 0.6rem;
  }

  tr:hover td {
    background: #1a1a1a;
  }

  article img {
    max-width: 100%;
    height: auto;
    max-height: 300px;
    object-fit: contain;
    cursor: zoom-in;
    border: 1px solid #332b00;
    display: block;
    margin: 0.5rem 0;
  }

  .gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.5rem;
    margin: 1rem 0;
  }

  .gallery img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    max-height: none;
  }

  .lightbox {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.92);
    z-index: 1000;
    cursor: zoom-out;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }

  .lightbox.active {
    display: flex;
  }

  .lightbox > #lightbox-img {
    max-width: 85vw;
    max-height: 70vh;
    object-fit: contain;
    border: 1px solid #332b00;
    cursor: zoom-in;
  }

  .lb-prev,
  .lb-next {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: #665200;
    font-size: 2rem;
    cursor: pointer;
    z-index: 1002;
    padding: 1rem;
    line-height: 1;
  }

  .lb-prev { left: 0.5rem; }
  .lb-next { right: 0.5rem; }

  .lb-prev:hover,
  .lb-next:hover {
    color: #ffcc00;
  }

  .lb-thumbs {
    display: flex;
    flex-direction: row;
    gap: 0.4rem;
    overflow-x: auto;
    max-width: 85vw;
    margin-top: 0.8rem;
    padding: 0.3rem 0;
    justify-content: center;
  }

  .lb-thumbs img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border: 2px solid #332b00;
    cursor: pointer;
    flex-shrink: 0;
  }

  .lb-thumbs img.active {
    border-color: #ffcc00;
  }

  .lb-thumbs img:hover {
    border-color: #665200;
  }

  .lb-thumbs img.active:hover {
    border-color: #ffcc00;
  }

  .lb-expand {
    position: fixed;
    top: 0.5rem;
    right: 0.5rem;
    background: transparent;
    border: none;
    color: #665200;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 1002;
    padding: 0.5rem;
    line-height: 1;
  }

  .lb-expand:hover {
    color: #ffcc00;
  }

  .lightbox.expanded {
    overflow: auto;
    display: flex;
    align-items: flex-start;
    justify-content: flex-start;
    cursor: zoom-out;
  }

  .lightbox.expanded > #lightbox-img {
    max-width: none;
    max-height: none;
    cursor: grab;
    margin: auto;
  }

  .lightbox.expanded .lb-prev,
  .lightbox.expanded .lb-next,
  .lightbox.expanded .lb-thumbs,
  .lightbox.expanded .lightbox-hint {
    display: none;
  }

  .lightbox-hint {
    position: relative;
    margin-top: 0.5rem;
    color: #665200;
    font-size: 0.8em;
    z-index: 1001;
  }

  .phone-wall {
    display: none;
  }

  @media (max-width: 600px) {
    .phone-wall {
      display: block;
    }

    .phone-wall pre {
      color: #ff4444;
      background: none !important;
      border: none !important;
      padding: 0 !important;
      white-space: pre-wrap;
    }

    main, footer {
      display: none;
    }
  }
</style>
